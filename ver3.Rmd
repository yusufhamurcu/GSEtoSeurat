---
title: "Haradhvala"
author: "Yusuf Hamurcu"
date: "`r Sys.Date()`"
output: html_document
---

# Library Installation
```{r}
suppressPackageStartupMessages(library(BPCells))
suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(data.table))
suppressPackageStartupMessages(library(Matrix))
suppressPackageStartupMessages(library(tidyverse))
``` 

# Extracting files

```{r,eval=FALSE}
# Patient files created but they are also in zipped form
untar("GSE197268_RAW.tar",exdir = "./tar_data")
files <- list.files("./tar_data")

# Patient files get extracted 
for (i in files){
  filname <- paste0("./tar_data/",i)
  untar(filname,exdir = "./tar_data")
  unlink(filname)
}

# After that all patient info in raw_data folder with matrix,barcodes and features files
```


```{r, eval=FALSE}
dir <- list.dirs("./tar_data")
dir <- dir[-1] # First one is upper folder direction ("./")

# Files in each folder(by patient) gets readed
for (i in dir){
  file_dir <- (paste0(i,"/",list.files(i)))
  for (a in file_dir){
    if (grepl("*matrix\\.mtx\\.gz",a)){
      mtx <- as(readMM(a),"dgCMatrix")
    }
    if (grepl("*barcodes\\.tsv\\.gz",a)){
      barcodes <- read.delim(a,header = F)
    }
    if (grepl("*features\\.tsv\\.gz",a)){
      features <- read.delim(a,header = F)
    }
  }
  
  # Barcodes and features get set in mtx
  
  colnames(mtx) <- barcodes$V1
  rownames(mtx) <- features$V2 # V1 is ensemble names
  
  # Each patient matrix get wrote in Seurat readable form
  
  dir_name <- paste0("./Matrixes/",substr(i,12,nchar(i)))
  write_matrix_dir(mtx,dir_name)
  #print(paste0("Done: ",i))
}

rm(barcodes,features,mtx)
unlink("./tar_data/", recursive = T) # Delete unnecessary folder
gc()
```


```{r}

dir <- list.dirs("../Matrixes")
dir <- dir[-1]

# Patients get read in bulk for SeuratObject creation

for (x in dir){
  obj <- open_matrix_dir(x)
  obj_name <- substr(x,12,nchar(x))
  obj <- CreateSeuratObject(obj, project = obj_name)
  assign(obj_name,obj)
  #print(paste0("Object Created: ", obj_name))
}

rm(obj,x,obj_name,dir)
ls()
gc()
```

```{r}
type_list <- c("Baseline$","Infusion$","D7$","D7-CART$","D14$")

for (i in type_list){
  sub_list <- lapply(ls(pattern = i),get)
  sub <- do.call(merge, sub_list)
  rm(list = ls(pattern = i))
  assign(substr(i,1,nchar(i)-1),sub)
}

{
rm(sub,sub_list,i,type_list)
`D7-CART-retreatment` <- CreateSeuratObject(`Patient29-D7-CART-retreatment`)
rm(`Patient29-D7-CART-retreatment`)  
`D7-retreatment` <- CreateSeuratObject(`Patient29-D7-retreatment`)
rm(`Patient29-D7-retreatment`)
`Infusion-retreatment` <- CreateSeuratObject(`Patient29-Infusion-retreatment`)
rm(`Patient29-Infusion-retreatment`)
gc()
  } 
  
```


```{r}
# Final wanted categories
# Patient29 D7-CART, D7-retreatment,Infusion-retreatment is not included because there are only one of them and it breaks the loop

type_list <- c("Baseline$","Infusion$","D7$","D7-CART$","D14$")

# Patients get called by categories

for (i in type_list){
  sub_list <- lapply(ls(pattern = i),get)
  sub <- do.call(cbind, sub_list) # cbind() combines matrixes in sub_list
  rm(list = ls(pattern = i))
  sub <- CreateSeuratObject(sub) # SeuratObject creation with combinated matrixes 
  assign(substr(i,1,nchar(i)-1),sub)
}

# Categories that have only one item gets created manually
{
rm(sub,sub_list,i,type_list)
`D7-CART-retreatment` <- CreateSeuratObject(`Patient29-D7-CART-retreatment`)
rm(`Patient29-D7-CART-retreatment`)  
`D7-retreatment` <- CreateSeuratObject(`Patient29-D7-retreatment`)
rm(`Patient29-D7-retreatment`)
`Infusion-retreatment` <- CreateSeuratObject(`Patient29-Infusion-retreatment`)
rm(`Patient29-Infusion-retreatment`)
gc()
  } 
  

```

```{r}
# Final control of objects
ls()
```


```{r}
co <- merge(`/Patient10-Baseline`,`/Patient11-Baseline`)
data <- co
data[["percent.mt"]] <- PercentageFeatureSet(data, pattern = "^MT-")
VlnPlot(data, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3)

plot1 <- FeatureScatter(data, feature1 = "nCount_RNA", feature2 = "percent.mt")
plot2 <- FeatureScatter(data, feature1 = "nCount_RNA", feature2 = "nFeature_RNA")
plot1 + plot2

data <- NormalizeData(data, normalization.method = "LogNormalize")
data <- FindVariableFeatures(data)

top10 <- head(VariableFeatures(data), 10)

plot1 <- VariableFeaturePlot(data)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2

all.genes <- rownames(data)
data <- ScaleData(data, features = all.genes)

data <- ScaleData(data, vars.to.regress = "percent.mt")

data <- RunPCA(data, features = VariableFeatures(object = data))

VizDimLoadings(data, dims = 1:2, reduction = "pca")

DimPlot(data, reduction = "pca")
DimHeatmap(data, dims = 1, cells = 500, balanced = TRUE)

data <- FindNeighbors(data, dims = 1:10)
data <- FindClusters(data, resolution = 0.5)
data <- RunUMAP(data, dims = 1:10)


p5 <- DimPlot(data, reduction = "umap",group.by = "orig.ident")
#ggsave("plot.jpeg", plot = p5, width = 8,height = 6)

"total 810"
"baseline from 154 to 725"
"expected after total 3900 MB"
```

